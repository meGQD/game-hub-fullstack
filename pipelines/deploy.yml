.deploy_rules:
  stage: deploy
  environment: 
    name: prod 
  tags:
    - deploy
  rules:
    - changes:
        - "pipelines/deploy.yml"  

deploy postgres:
  extends: .deploy_rules
  rules:
    - changes:
        - "kubernetes/charts/postgres/**/*"    
  script:
    - helm upgrade --install postgres-cloudpirates oci://registry-1.docker.io/cloudpirates/postgres --version 0.5.5 -f ./kubernetes/charts/postgres/values.yaml

deploy redis:
  extends: .deploy_rules
  rules:
    - changes:
        - "kubernetes/charts/redis/**/*"      
  script:
    - helm upgrade --install redis-bitnami oci://registry-1.docker.io/bitnamicharts/redis --version 24.1.0 -f ./kubernetes/charts/redis/values.yaml

deploy backend:
  extends: .deploy_rules
  needs:
    - job: "build backend"
      optional: true
  rules:
    - changes:
        - "backend/**/*"
        - "kubernetes/charts/backend/**/*"      
  script:
    - |
      helm upgrade --install backend ./kubernetes/charts/backend \
        --set image.tag=$CI_COMMIT_SHORT_SHA \
        --set config.DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE \
        --set config.SEEDING_MAX_PAGES=$SEEDING_MAX_PAGES \
        --set config.ALLOWED_HOSTS=$ALLOWED_HOSTS \
        --set config.FRONTEND_URL=$FRONTEND_URL \
        --set config.REDIS_LOCATION=$REDIS_LOCATION \
        --set config.DB_HOST=$DB_HOST \
        --set config.DB_PORT=$DB_PORT 

deploy frontend:
  extends: .deploy_rules
  needs:
    - job: "build frontend"
      optional: true
  rules:
    - changes:
        - "frontend/**/*"
        - "kubernetes/charts/frontend/**/*"      
  script:
    - |
      helm upgrade --install frontend ./kubernetes/charts/frontend \
        --set image.tag=$CI_COMMIT_SHORT_SHA